<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>01 Download &amp; Preprocessing • mapme.forest</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="01 Download &amp; Preprocessing">
<meta property="og:description" content="mapme.forest">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">mapme.forest</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/GFW.html">01 Download &amp; Preprocessing</a>
    </li>
    <li>
      <a href="../articles/area_stats.html">02 Area Statistics</a>
    </li>
    <li>
      <a href="../articles/big_data.html">04 Big Data Analysis</a>
    </li>
    <li>
      <a href="../articles/frag_stats.html">03 Fragmentation Statistics</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="GFW_files/accessible-code-block-0.0.1/empty-anchor.js"></script><link href="GFW_files/anchor-sections-1.0/anchor-sections.css" rel="stylesheet">
<script src="GFW_files/anchor-sections-1.0/anchor-sections.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>01 Download &amp; Preprocessing</h1>
                        <h4 class="author">Darius Görgen</h4>
            
            <h4 class="date">2020-12-11</h4>
      
      
      <div class="hidden name"><code>GFW.Rmd</code></div>

    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://rspatial.org/raster">raster</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://igraph.org">igraph</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tibble.tidyverse.org/">tibble</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-spatial.github.io/sf/">sf</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://ggplot2.tidyverse.org">ggplot2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="http://stringr.tidyverse.org">stringr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va">mapme.forest</span><span class="op">)</span></code></pre></div>
<div id="intro-to-global-forest-watch" class="section level2">
<h2 class="hasAnchor">
<a href="#intro-to-global-forest-watch" class="anchor"></a>Intro to Global Forest Watch</h2>
<p><a href="https://www.globalforestwatch.org/">Global Forest Watch</a> makes available global data products produced by Hansen et al (2013) by examining Landsat satellite data to characterize global forest extent, annual loss, and gain. These data and their annual updates provide spatially detailed information on forest cover. However, some challenges arise when using Earth Observation (EO) to assess trends in forest loss. In the context of forest conservation, spatial statistics can assist in quickly identifying spatio-temporal trends of forest loss without the explicit need for pre-existing information on what underlying factors are driving these trends. However, there remains the challenge to distinguish between loss of forest cover caused by intentional clearing and loss of forest due to natural disturbances.</p>
<p>We can find following data layers in the GFW data set:</p>
<ul>
<li><p>‘Treecover2000’: This layer gives the tree canopy cover for year 2000, defined as canopy closure for all vegetation taller than 5m in height, measured in percentage ranging from 0 to 100 percent</p></li>
<li><p>‘Loss’: This layer gives the tree cover loss during the study period, defined as a complete stand-replacement disturbance (i.e., a change from a forest to non-forest state).</p></li>
<li><p>‘Gain’: Tree cover gain summarized during the period 2000–2012, defined as the inverse of the information contained in the ‘Loss’ layer (a non-forest to forest change entirely within the study period)</p></li>
<li><p>‘Lossyear’: Year of gross tree cover loss event. Tree cover loss during the study period, defined as a stand-replacement disturbance, or a change from a forest to non-forest state. Encoded as either 0 (no loss) or else a value in the range 1–18, representing loss detected primarily in the year 2001–2018</p></li>
</ul>
<p>The conceptual challenge with this data set is that the overall losses and gains are provided as gross estimates between the year 2000 and 2018. This means that we cannot obtain annual maps of forest losses and gains to retrieve annual net deforestation values. We can, however, derive a gross estimate of forest clearance by using the loss year layer. Here, every stand-replacement disturbance is associated to a specific year in the time series 2000-2018, so we can obtain binary forest loss maps for every year. It is important to note that the possibility of forest gains during the time series is not accounted for in this approach. This is a shortcoming, however it was chose to deliver inexpensive but reliable first insights into deforestation dynamics.</p>
</div>
<div id="download-data" class="section level2">
<h2 class="hasAnchor">
<a href="#download-data" class="anchor"></a>Download data</h2>
<p>We can download the data for any given area of interest presented to the download function as an sf-object. With the basename variable we can specify any character string with which is prepended to the file names. The specification of the dataset variable defines which version of the GFW to download. The default is version 1.6 which tracks forest cover dynamics between 2000 and 2018. A newer version (1.7) which also includes the year 2019 is already available. Simply change the dataset variable to “GFC-2019-v.1.7”. The variable outdir specifies where to put the final merged raster files, because single tiles are first downloaded into the .tmpdir directory and then mosaiced through a gdal system call. You can choose to keep the single tiles by specifying <code>keepTmpFiles = TRUE</code> if you wish to keep them for future analysis. When a specific tile is needed for the requested area of interest, but already found in the .tmpdir, it is not going to be downloaded again. This can come in handy if you work on different projects, e.g. in the same country. Note, that the CO2 dataset has a limited availability because this dataset is roughly present for the tropics and subtropics between 30N and 30S. You can check the availability . In cases where there is no CO2 data for the requested AOI, the function will not issue a warning but simply append an empty CO2 raster. This does not mean that in these areas there has not been any CO2 emissions trough forest cover clearing but simply that it was not measured in the data source.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># read in polygons of interest</span>
<span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_read.html">st_read</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/system.file.html">system.file</a></span><span class="op">(</span><span class="st">"extdata"</span>, <span class="st">"aoi_polys.gpkg"</span>, package <span class="op">=</span> <span class="st">"mapme.forest"</span><span class="op">)</span><span class="op">)</span>

<span class="co"># download GFW data for the area of interest</span>
<span class="va">raster_files</span> <span class="op">=</span> <span class="fu"><a href="../reference/downloadfGFW.html">downloadfGFW</a></span><span class="op">(</span>shape <span class="op">=</span> <span class="va">aoi</span>,
                            basename <span class="op">=</span> <span class="st">"pkgTest"</span>,
                            dataset <span class="op">=</span> <span class="st">"GFC-2018-v1.6"</span>,
                            outdir <span class="op">=</span> <span class="st">"../data/"</span>,
                            keepTmpFiles <span class="op">=</span> <span class="cn">T</span>,
                            .tmpdir <span class="op">=</span> <span class="st">"../data/tmp"</span><span class="op">)</span>

<span class="co"># in case the projection between aoi and the downloaded rasters is different,</span>
<span class="co"># we need to reproject the aoi object</span>
<span class="va">aoi</span> <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_transform.html">st_transform</a></span><span class="op">(</span><span class="va">aoi</span>, crs <span class="op">=</span> <span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/raster.html">raster</a></span><span class="op">(</span><span class="va">raster_files</span><span class="op">[</span><span class="fl">1</span><span class="op">]</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>
<span class="co"># crop the rasters to the extent of the aoi</span>
<span class="va">rasters</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/lapply.html">lapply</a></span><span class="op">(</span><span class="va">raster_files</span>, <span class="kw">function</span><span class="op">(</span><span class="va">f</span><span class="op">)</span><span class="op">{</span>
  <span class="va">f</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/brick.html">brick</a></span><span class="op">(</span><span class="va">f</span><span class="op">)</span>
  <span class="va">f</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/crop.html">crop</a></span><span class="op">(</span><span class="va">f</span>, <span class="va">aoi</span><span class="op">)</span>
<span class="op">}</span><span class="op">)</span><span class="op">)</span>
<span class="co"># assigning proper names to the layers and simply plot the results</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">rasters</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"co2_emission"</span>, <span class="st">"lossyear"</span>, <span class="st">"treecover"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">rasters</span><span class="op">)</span></code></pre></div>
<p><img src="GFW_files/figure-html/load-data-1.png" width="700"></p>
</div>
<div id="preprocessing" class="section level2">
<h2 class="hasAnchor">
<a href="#preprocessing" class="anchor"></a>Preprocessing</h2>
<p>We can use the loss year layer and the tree cover layer for the year 2000 to calculate binary tree cover maps while modeling different forest definitions. For this usage we developed an simple interface to an R routine doing the work for us called <code><a href="../reference/prepTC.html">prepTC()</a></code>.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">prep_treeCover</span> <span class="op">=</span> <span class="fu"><a href="../reference/prepTC.html">prepTC</a></span><span class="op">(</span>inputForestMap <span class="op">=</span> <span class="va">rasters</span><span class="op">$</span><span class="va">treecover</span>,
                        thresholdCover <span class="op">=</span> <span class="fl">75</span>,
                        thresholdClump <span class="op">=</span> <span class="fl">20</span><span class="op">)</span></code></pre></div>
<p>This function applies both, the classification to a binary raster by applying a cover threshold and removing clumps of raster cells smaller than a given threshold. The routine is also able to apply only either one of these tasks. Note, however, that the functions to calculate areal statistics expect binary rasters as input. Next, we are going to explain in detail how both of these thresholds are applied.</p>
</div>
<div id="coverage-threshold" class="section level2">
<h2 class="hasAnchor">
<a href="#coverage-threshold" class="anchor"></a>Coverage Threshold</h2>
<p>We can see the tree cover map for the year 2000 which is coded in percentage of tree canopy coverage between 0 and 100. Using that information, we are able to apply a threshold reclassification to model national forest definitions, for example a tree canopy larger that 50% of the ground’s surface. For the loss year layer, most of the pixels are plotted in a grayish color. Those are the pixels having a value of 0 meaning that no tree cover loss was observed in the time series 2000 to 2018. From redish to green, the other pixels indicate the year when forest loss occurred. We are going to use this information to retrieve annual forest maps in conjunction with the tree cover layer for the base year 2000. However, we take a look at the effect of applying a threshold filtering to the tree cover layer first.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">treeCover_binary</span> <span class="op">=</span> <span class="va">rasters</span><span class="op">$</span><span class="va">treecover</span>
<span class="va">treeCover_binary</span><span class="op">[</span><span class="va">rasters</span><span class="op">$</span><span class="va">treecover</span><span class="op">&lt;</span> <span class="fl">50</span> <span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>
<span class="va">treeCover_binary</span><span class="op">[</span><span class="va">rasters</span><span class="op">$</span><span class="va">treecover</span><span class="op">&gt;=</span> <span class="fl">50</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">treeCover_binary</span><span class="op">)</span></code></pre></div>
<p><img src="GFW_files/figure-html/treecover_filter-1.png" width="700"></p>
<p>We applied a threshold for tree cover of 50% and recoded all values below to 0 while all values equal or greater than our threshold to 1. This way we obtained a binary forest mask for the year 2000 corresponding to our forest definition of 50% tree canopy over the soil surface.</p>
</div>
<div id="clump-removal" class="section level2">
<h2 class="hasAnchor">
<a href="#clump-removal" class="anchor"></a>Clump Removal</h2>
<p>Some national agencies as well as international organizations might concentrate their efforts and definitions in forest conservation to areas with a minimum size of comprehensive tree cover. To account for this we can apply a clump detection. This algorithm basically assigns an increasing value starting from 1 to every comprehensive clump it finds in the data. When all the pixels of one clump were assigned with the same value and no more pixels are adjacent to any pixels in the clump, the algorithm jumps to the next clump and assigns these pixels a value increased by one. For our sample area, this looks like this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">treeCover_clumps</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/clump.html">clump</a></span><span class="op">(</span><span class="va">treeCover_binary</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">treeCover_clumps</span><span class="op">)</span></code></pre></div>
<p><img src="GFW_files/figure-html/treecover_clumps-1.png" width="700"></p>
<p>Most of the pixels show the same greyish colour, indicating that they are compromised in one and the same clumps, however, we can observe increasing raster cell values from North to South for some minor areas. This means that the algorithm started to distribute number for clumps in the North and then slowly moving downwards to the South until every pixel was associated with a clump. By taking a look at the frequency a certain clump class occurs in this new data set, we can apply another threshold to remove clumps which are smaller than our desired value. For this to work as expected, we have to take into account the cell size of our raster data. To interpret the cell size we additionally need information on the coordinate reference system (CRS) our data currently is represented in.</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://r-spatial.github.io/sf/reference/st_crs.html">st_crs</a></span><span class="op">(</span><span class="va">treeCover_clumps</span><span class="op">)</span> <span class="co"># retrives the coordinate reference system</span>
<span class="co">#&gt; Coordinate Reference System:</span>
<span class="co">#&gt;   User input: +proj=longlat +datum=WGS84 +no_defs </span>
<span class="co">#&gt;   wkt:</span>
<span class="co">#&gt; GEOGCRS["unknown",</span>
<span class="co">#&gt;     DATUM["World Geodetic System 1984",</span>
<span class="co">#&gt;         ELLIPSOID["WGS 84",6378137,298.257223563,</span>
<span class="co">#&gt;             LENGTHUNIT["metre",1]],</span>
<span class="co">#&gt;         ID["EPSG",6326]],</span>
<span class="co">#&gt;     PRIMEM["Greenwich",0,</span>
<span class="co">#&gt;         ANGLEUNIT["degree",0.0174532925199433],</span>
<span class="co">#&gt;         ID["EPSG",8901]],</span>
<span class="co">#&gt;     CS[ellipsoidal,2],</span>
<span class="co">#&gt;         AXIS["longitude",east,</span>
<span class="co">#&gt;             ORDER[1],</span>
<span class="co">#&gt;             ANGLEUNIT["degree",0.0174532925199433,</span>
<span class="co">#&gt;                 ID["EPSG",9122]]],</span>
<span class="co">#&gt;         AXIS["latitude",north,</span>
<span class="co">#&gt;             ORDER[2],</span>
<span class="co">#&gt;             ANGLEUNIT["degree",0.0174532925199433,</span>
<span class="co">#&gt;                 ID["EPSG",9122]]]]</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/resolution.html">res</a></span><span class="op">(</span><span class="va">treeCover_clumps</span><span class="op">)</span> <span class="co"># gives the cell size in x and y direction</span>
<span class="co">#&gt; [1] 0.00025 0.00025</span></code></pre></div>
<p>We can see that our data is represented in geographic coordinates, based on the geographic datum and reference ellipsoid WGS84. This means that the units of our pixels resolution needs to be interpreted as degrees because the data was not projected to a planar coordinate system. We could do this now, to apply our threshold in terms of meters or hectares. But we can also estimate our desired threshold based on degrees. At the equator, one degree in East-West direction (x) is equal to 100km. In kilometers, this distance is reduced the closer we get to the poles. This means that our pixel size in meters is approximately 25 ~ 30 meters. Now, if we want to filter for forest areas which are at leas 5 ha in size, we need to translate this into the number of pixels which represent a clump of that desired size. One pixel has 30m x 30m = 900m², a forest area of 5ha * 10,000m²/ha = 50,000m², so 50,000m² / 900m² = 5.55 pixels. So here we choose a threshold of a minimum size of 6 pixels. First, however we use the <code>freq</code>-function to calculate the number of occurrences per clump class in our raster. Then, we can filter for values which show occurrences lower to our threshold and set them to 0.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">frequencies</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/freq.html">freq</a></span><span class="op">(</span><span class="va">treeCover_clumps</span><span class="op">)</span><span class="op">)</span> <span class="co"># gets frequency per value</span>
<span class="va">filt_frequencies</span> <span class="op">=</span> <span class="va">frequencies</span> <span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">frequencies</span> <span class="op">$</span><span class="va">count</span> <span class="op">&gt;=</span> <span class="fl">6</span><span class="op">)</span>, <span class="op">]</span> <span class="co"># selects only those values with frequencies &gt; 5</span>
<span class="va">filt_frequencies</span>  <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.matrix.html">as.vector</a></span><span class="op">(</span><span class="va">filt_frequencies</span> <span class="op">$</span><span class="va">value</span><span class="op">)</span> <span class="co"># to vector</span>

<span class="va">treeCover_clean</span> <span class="op">=</span> <span class="va">treeCover_clumps</span> <span class="co"># initiate clean raster</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">treeCover_clean</span><span class="op">)</span> <span class="op">=</span> <span class="st">"clumps.removed"</span>
<span class="va">treeCover_clean</span><span class="op">[</span><span class="op">!</span><span class="va">treeCover_clean</span> <span class="op">%in%</span> <span class="va">filt_frequencies</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>
<span class="va">treeCover_clean</span><span class="op">[</span><span class="va">treeCover_clean</span> <span class="op">!=</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">treeCover_binary</span>, <span class="va">treeCover_clean</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="GFW_files/figure-html/treecover_freq-1.png" width="700"></p>
<p>We can observe some differences in the resulting output of the two rasters with smaller patches of forest removed from the right hand raster. We now compare the results of our manually applied processing to the results we obtained with calling the function <code><a href="../reference/prepTC.html">prepTC()</a></code> at the very beginning of this tutorial.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">prep_treeCover</span><span class="op">)</span> <span class="op">=</span> <span class="st">"cover75.clumps20"</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">treeCover_clean</span><span class="op">)</span> <span class="op">=</span> <span class="st">"cover50.clumps5"</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/stack.html">stack</a></span><span class="op">(</span><span class="va">treeCover_clean</span>, <span class="va">prep_treeCover</span><span class="op">)</span><span class="op">)</span></code></pre></div>
<p><img src="GFW_files/figure-html/unnamed-chunk-3-1.png" width="700"></p>
</div>
<div id="yearly-forest-mask" class="section level2">
<h2 class="hasAnchor">
<a href="#yearly-forest-mask" class="anchor"></a>Yearly Forest Mask</h2>
<p>The next step is to retrieve pseudo-yearly forest cover maps from the loss year layer. For this step, too, we create a R routine which eases this process significantly. It can be applied directly to an input of the forest cover map from the base year and the loss year layer. Note, that the years vector indicates the years which are present in the loss year layer excluding the base years specified as input.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="va">yearlyForestMask</span> <span class="op">=</span> <span class="fu"><a href="../reference/getTM.html">getTM</a></span><span class="op">(</span>inputForestMap <span class="op">=</span> <span class="va">treeCover_clean</span>,
                         inputLossMap <span class="op">=</span> <span class="va">rasters</span><span class="op">$</span><span class="va">lossyear</span>,
                         years <span class="op">=</span> <span class="fl">2001</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span></code></pre></div>
<p>But what would the workflow look like, if we were doing it manually? We use the first raster layer we obtained by applying the threshold pre-processing as our base layer for the year 2000. We then recode the value 0, which represents no forest loss in the entire time series to NA. Then, we loop through the remaining year values from 1 to 18 and reclassify all pixels in our base tree cover layer to 0 which are equal or lower to the current year value in the loss year layer.</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># set value of 0 to NA</span>
<span class="va">rasters</span><span class="op">$</span><span class="va">lossyear</span><span class="op">[</span><span class="va">rasters</span><span class="op">$</span><span class="va">lossyear</span> <span class="op">==</span> <span class="fl">0</span><span class="op">]</span> <span class="op">=</span> <span class="cn">NA</span>
<span class="co"># mask lossyear layer to our binary mask so onyl valid pixels remain</span>
<span class="va">rasters</span><span class="op">$</span><span class="va">lossyear</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/mask.html">mask</a></span><span class="op">(</span><span class="va">rasters</span><span class="op">$</span><span class="va">lossyear</span>, <span class="va">treeCover_clean</span><span class="op">)</span>
<span class="co"># vector of values found in loss year, 1 : 2001, 2: 2002 ... 18: 2018</span>
<span class="va">unis</span> <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="fl">18</span>

<span class="co"># initiate the yearlyForestMask raster stack with the binary layer for 2000</span>
<span class="va">yearlyForestMask</span> <span class="op">=</span> <span class="va">treeCover_clean</span>

<span class="co"># loop trough the year values and set them to 1 in case they are</span>
<span class="co"># lower or equal to the current value (Forest Loss) or 0 when</span>
<span class="co"># they are greater (no forest loss during that year)</span>
<span class="kw">for</span> <span class="op">(</span><span class="va">u</span> <span class="kw">in</span> <span class="va">unis</span><span class="op">)</span><span class="op">{</span>
  <span class="va">tmpLS</span> <span class="op">=</span> <span class="va">rasters</span><span class="op">$</span><span class="va">lossyear</span>
  <span class="va">tmpLS</span><span class="op">[</span><span class="va">tmpLS</span> <span class="op">&lt;=</span> <span class="va">u</span><span class="op">]</span> <span class="op">=</span> <span class="fl">1</span>
  <span class="va">tmpLS</span><span class="op">[</span><span class="va">tmpLS</span> <span class="op">&gt;</span> <span class="va">u</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>
  
  <span class="co"># set the pixels in the binary forest mask to 0 which </span>
  <span class="co"># showed forest loss in the current year of years before</span>
  <span class="va">tmpTC</span> <span class="op">=</span> <span class="va">treeCover_clean</span>
  <span class="va">tmpTC</span><span class="op">[</span><span class="va">tmpLS</span> <span class="op">==</span> <span class="fl">1</span><span class="op">]</span> <span class="op">=</span> <span class="fl">0</span>
  <span class="co"># add the resulting layer to the raster stack</span>
  <span class="va">yearlyForestMask</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/raster/man/addLayer.html">addLayer</a></span><span class="op">(</span><span class="va">yearlyForestMask</span>, <span class="va">tmpTC</span><span class="op">)</span>
<span class="op">}</span>
<span class="co"># renaming and simple plot</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/names.html">names</a></span><span class="op">(</span><span class="va">yearlyForestMask</span><span class="op">)</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="st">"y"</span>, <span class="fl">2000</span><span class="op">:</span><span class="fl">2018</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">yearlyForestMask</span><span class="op">[[</span><span class="fl">11</span><span class="op">:</span><span class="fl">19</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="GFW_files/figure-html/lossyear-1.png" width="700"></p>
<p>With this processes we retrieved a yearly binary forest mask. Note that at this stage we only applied our threshold for the minimal mapping unit for the base year in 2000. In cases we want to apply the same threshold to the remaining years an additional working step is needed.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw">for</span> <span class="op">(</span><span class="va">l</span> <span class="kw">in</span> <span class="fl">1</span><span class="op">:</span><span class="fu"><a href="https://rdrr.io/pkg/raster/man/nlayers.html">nlayers</a></span><span class="op">(</span><span class="va">yearlyForestMask</span><span class="op">)</span><span class="op">)</span><span class="op">{</span>
<span class="va">yearlyForestMask</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span> <span class="op">=</span> <span class="fu"><a href="../reference/prepTC.html">prepTC</a></span><span class="op">(</span><span class="va">yearlyForestMask</span><span class="op">[[</span><span class="va">l</span><span class="op">]</span><span class="op">]</span>, thresholdClump <span class="op">=</span> <span class="fl">5</span><span class="op">)</span>
<span class="op">}</span>

<span class="fu"><a href="https://rdrr.io/pkg/raster/man/plot.html">plot</a></span><span class="op">(</span><span class="va">yearlyForestMask</span><span class="op">[[</span><span class="fl">1</span><span class="op">:</span><span class="fl">8</span><span class="op">]</span><span class="op">]</span><span class="op">)</span></code></pre></div>
<p><img src="GFW_files/figure-html/mmu_yearly-1.png" width="700"></p>
<p>It is hard to tell exact differences between the raster layers. Therefore we do a quick pixel count of pixels representing forest as an estimation of the forest area.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="fu"><a href="https://rdrr.io/pkg/raster/man/as.data.frame.html">as.data.frame</a></span><span class="op">(</span><span class="va">yearlyForestMask</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise_all.html">summarise_all</a></span><span class="op">(</span><span class="va">sum</span>, na.rm<span class="op">=</span><span class="cn">TRUE</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/gather.html">gather</a></span><span class="op">(</span><span class="st">"year"</span>,<span class="st">"value"</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>year <span class="op">=</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">year</span>, <span class="op">-</span><span class="fl">4</span>, <span class="op">-</span><span class="fl">1</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x<span class="op">=</span> <span class="va">year</span>, y<span class="op">=</span><span class="va">value</span><span class="op">)</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span>stat<span class="op">=</span><span class="st">"identity"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">ylab</a></span><span class="op">(</span><span class="st">"Number of forest pixels"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">xlab</a></span><span class="op">(</span><span class="st">"Year of Observation"</span><span class="op">)</span><span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_minimal</a></span><span class="op">(</span><span class="op">)</span></code></pre></div>
<p><img src="GFW_files/figure-html/barplot-1.png" width="700"></p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by KfW Bankengruppe, Darius Görgen, Fabian Löw.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
